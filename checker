import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;
import org.springframework.http.HttpEntity;
import org.springframework.test.util.ReflectionTestUtils;
import org.springframework.web.client.RestTemplate;

import com.jpmorgan.moneta.boot.ida.client.IdaTokenProvider;
import com.jpmorgan.moneta.boot.ida.client.IdaTokenResponse;

public class RequestHandlerClientServiceImplTest {

    @Mock
    private RestTemplate restTemplate;

    @Mock
    private RestTemplate c2dcRestTemplate;

    @Mock
    private IdaTokenProvider idaTokenProvider;

    @Mock
    private IdaTokenResponse idaTokenResponse; // <-- mock the response

    @InjectMocks
    private RequestHandlerClientServiceImpl service;

    @BeforeEach
    public void setUp() {
        MockitoAnnotations.openMocks(this);
        ReflectionTestUtils.setField(service, "url", "http://dummy-url");
    }

    @Test
    public void testPostQueryToTrino() {
        // Mock token provider chain
        when(idaTokenProvider.get()).thenReturn(idaTokenResponse);
        when(idaTokenResponse.getAccessToken()).thenReturn("token");

        // Mock RestTemplate call
        when(c2dcRestTemplate.postForObject(
                eq("http://dummy-url/v1/statement"),
                any(HttpEntity.class),
                eq(String.class))
        ).thenReturn("OK");

        // Call the method
        service.PostQueryToTrino("SELECT 1");

        // Verify the interaction
        verify(c2dcRestTemplate).postForObject(
                eq("http://dummy-url/v1/statement"),
                any(HttpEntity.class),
                eq(String.class)
        );
    }
}
