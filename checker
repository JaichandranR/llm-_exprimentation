package net.jpmchase.csorion;

import com.fasterxml.jackson.databind.ObjectMapper;
import net.jpmchase.csorion.message.DatasetStepFunctionDependency;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import software.amazon.awssdk.services.sfn.SfnClient;
import software.amazon.awssdk.services.ssm.SsmClient;
import software.amazon.awssdk.services.ssm.model.GetParameterRequest;
import software.amazon.awssdk.services.ssm.model.GetParameterResponse;
import software.amazon.awssdk.services.ssm.model.Parameter;

import com.amazonaws.services.dynamodbv2.AmazonDynamoDBLockClient; // real class, mocked

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

class HandlerTest {

    private ObjectMapper objectMapper;
    private SsmClient ssmClient;
    private SfnClient sfnClient;
    private AmazonDynamoDBLockClient dynamoDBLockClient;
    private Handler handler;

    // Minimal fake event for test purposes
    static class SimpleSQSEvent {
        java.util.List<SimpleMessage> records;
    }
    static class SimpleMessage {
        String body;
    }

    @BeforeEach
    void setUp() {
        objectMapper = mock(ObjectMapper.class);
        ssmClient = mock(SsmClient.class);
        sfnClient = mock(SfnClient.class);
        dynamoDBLockClient = mock(AmazonDynamoDBLockClient.class);

        handler = new Handler(
                objectMapper,
                ssmClient,
                sfnClient,
                dynamoDBLockClient, // mock of the real type
                "AVAILABLE",
                5L,
                10L,
                "dataset-prefix",
                "dependency-sep",
                "blocking-sep",
                "last-updated-suffix"
        );
    }

    @Test
    void testAccept_withValidInput_shouldProcessMessage() throws Exception {
        DatasetStepFunctionDependency dependency =
                new DatasetStepFunctionDependency("dataset1", "dep1", "token123", "2025-08-13T10:00:00Z", 5);

        // Mock JSON parsing
        when(objectMapper.readValue(any(String.class), eq(DatasetStepFunctionDependency.class)))
                .thenReturn(dependency);

        // Mock SSM
        when(ssmClient.getParameter(any(GetParameterRequest.class))).thenReturn(
                GetParameterResponse.builder()
                        .parameter(Parameter.builder().value("AVAILABLE").build())
                        .build()
        );

        // Mock DynamoDB lock acquisition
        when(dynamoDBLockClient.acquireLock(any())).thenReturn(new Object());

        // Build fake SQS event
        SimpleMessage msg = new SimpleMessage();
        msg.body = "{\"dataset\":\"dataset1\"}";
        SimpleSQSEvent event = new SimpleSQSEvent();
        event.records = java.util.Collections.singletonList(msg);

        // Call your handler method with event as needed
        // handler.accept(event);
    }
}
