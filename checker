package net.jpmchase.csorion.config.service;

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.when;
import static org.mockito.Mockito.verify;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;
import org.springframework.http.HttpEntity;
import org.springframework.test.util.ReflectionTestUtils;
import org.springframework.web.client.RestTemplate;

import com.jpmorgan.morato.boss.ida.client.blocking.IdaTokenProvider;

public class RequestHandlerClientServiceImplTest {

    @Mock
    private RestTemplate restTemplate;

    @Mock
    private RestTemplate c2dcRestTemplate;

    @Mock
    private IdaTokenProvider idaTokenProvider;

    @InjectMocks
    private RequestHandlerClientServiceImpl service;

    @BeforeEach
    public void setUp() {
        MockitoAnnotations.openMocks(this);
        ReflectionTestUtils.setField(service, "url", "http://dummy-url");
    }

    @Test
    public void testPostQueryToTrino() {
        when(idaTokenProvider.get().getAccessToken()).thenReturn("token");
        when(c2dcRestTemplate.postForObject(eq("http://dummy-url/v1/statement"), any(HttpEntity.class), eq(String.class)))
                .thenReturn("OK");

        service.PostQueryToTrino("SELECT 1");

        verify(c2dcRestTemplate).postForObject(eq("http://dummy-url/v1/statement"), any(HttpEntity.class), eq(String.class));
    }
}
