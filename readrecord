import boto3
import traceback
from botocore.exceptions import NoCredentialsError, PartialCredentialsError, ConnectTimeoutError, ClientError
from pyspark.sql import SparkSession

def list_glue_databases_and_tables(glue_client, database_name, table_name, catalog_id):
    """ List Glue databases and tables to verify metadata access """
    try:
        dbs = glue_client.get_databases(CatalogId=catalog_id)
        print("‚úÖ Databases in AWS Glue Data Catalog:")
        for db in dbs["DatabaseList"]:
            print(f" - {db['Name']}")

        tables = glue_client.get_tables(DatabaseName=database_name, CatalogId=catalog_id)
        print(f"\n‚úÖ Tables in '{database_name}':")
        for table in tables["TableList"]:
            print(f" - {table['Name']}")

        print(f"\nüîç Fetching first 10 rows from table: {table_name}")

    except NoCredentialsError:
        print("[ERROR] AWS credentials not found. Please configure your credentials.")
    except PartialCredentialsError:
        print("[ERROR] Incomplete AWS credentials. Please check your configuration.")
    except ConnectTimeoutError:
        print("[ERROR] Connection timed out. Please check your network connectivity.")
    except ClientError as e:
        print(f"[ERROR] AWS Client error: {e}")
    except Exception as e:
        print(f"[ERROR] Unexpected error: {str(e)}")
        print(traceback.format_exc())

def fetch_first_10_rows(database_name, table_name, catalog_id):
    """ Fetch the first 10 rows from an AWS Glue Iceberg table using PySpark """
    try:
        # Initialize Spark Session with Iceberg Support
        spark = SparkSession.builder \
            .appName("GlueIcebergQuery") \
            .config("spark.sql.catalog.glue_catalog", "org.apache.iceberg.spark.SparkCatalog") \
            .config("spark.sql.catalog.glue_catalog.catalog-impl", "org.apache.iceberg.aws.glue.GlueCatalog") \
            .config("spark.sql.catalog.glue_catalog.warehouse", "s3://your-glue-warehouse-bucket/") \
            .config("spark.sql.extensions", "org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions") \
            .getOrCreate()

        # Show databases & tables in Spark
        print("\nüîç Checking Spark Databases:")
        spark.sql("SHOW DATABASES").show()

        print(f"\nüîç Checking Tables in {database_name}:")
        spark.sql(f"SHOW TABLES IN {database_name}").show()

        # Verify Iceberg snapshots exist before querying
        print("\nüîç Checking Iceberg table snapshots:")
        spark.sql(f"CALL glue_catalog.system.snapshot('{database_name}.{table_name}')").show()

        # Try alternative table paths in `.load()`
        iceberg_table_paths = [
            f"glue_catalog.{database_name}.{table_name}",
            f"{database_name}.{table_name}",
            f"glue.common_data_dev.{table_name}",
            f"iceberg_catalog.common_data_dev.{table_name}"
        ]

        for iceberg_table in iceberg_table_paths:
            try:
                print(f"\nüîç Attempting to read Iceberg table using `.load()`: {iceberg_table}")
                df = spark.read.format("iceberg").load(iceberg_table)
                df.show(10, truncate=False)
                print(f"‚úÖ Successfully read Iceberg table using path: {iceberg_table}")
                return  # Stop if successful
            except Exception as e:
                print(f"[WARNING] Failed to read table with path {iceberg_table}: {e}")

        # If all `.load()` attempts fail, try SQL query
        print("\nüîç Attempting to read Iceberg table using SQL query...")
        spark.sql(f"SELECT * FROM glue_catalog.{database_name}.{table_name} LIMIT 10").show()

    except Exception as e:
        print(f"[ERROR] An unexpected error occurred while fetching records: {str(e)}")
        print(traceback.format_exc())

def main():
    role_arn = "arn:aws:iam::691272445312:role/lancholers/services/AWSGlueServiceRole-90177-tf"
    session_name = "GlueJobRunnerSession-123"
    region_name = "us-east-1"
    catalog_id = "809616259930"
    database_name = "common_data_dev"
    table_name = "87674_verum_application"

    try:
        # Initialize AWS Glue Client
        glue_client = boto3.client("glue", region_name=region_name)

        # Step 1: List Databases & Tables
        list_glue_databases_and_tables(glue_client, database_name, table_name, catalog_id)

        # Step 2: Fetch First 10 Rows from Iceberg Table
        fetch_first_10_rows(database_name, table_name, catalog_id)

    except Exception as e:
        print(f"[ERROR] An error occurred in main(): {str(e)}")
        print(traceback.format_exc())

if __name__ == "__main__":
    main()
