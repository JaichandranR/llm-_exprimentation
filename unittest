import unittest
from unittest.mock import patch, MagicMock

import sys
sys.modules['awsglue'] = MagicMock()
sys.modules['awsglue.context'] = MagicMock()
sys.modules['awsglue.utils'] = MagicMock()
sys.modules['pyspark'] = MagicMock()
sys.modules['pyspark.context'] = MagicMock()

class TestCommonDataSync(unittest.TestCase):

    @patch("src.main.python.common_data_sync.getResolvedOptions")
    @patch("src.main.python.common_data_sync.SparkContext")
    @patch("src.main.python.common_data_sync.GlueContext")
    @patch("src.main.python.common_data_sync.boto3.client")
    def test_copy_tables_successful(self, mock_boto3_client, mock_glue_context, mock_spark_context, mock_get_resolved):
        # Must be set BEFORE importing common_data_sync
        mock_get_resolved.return_value = {
            'source_db': 'source_db_name',
            'target_db': 'target_db_name',
            's3_bucket': 'mock-bucket',
            'region': 'us-east-1'
        }

        # Delayed import to ensure region is patched before boto3 client is created
        from src.main.python import common_data_sync

        mock_paginator = MagicMock()
        mock_paginator.paginate.return_value = [[
            {
                'Name': 'test_table',
                'StorageDescriptor': {
                    'Location': 's3://mock-location/',
                    'Columns': [],
                    'SerdeInfo': {}
                },
                'PartitionKeys': [],
                'Parameters': {
                    'classification': 'json',
                    'table_type': 'OTHER',
                    'metadata_location': 's3://mock-location/table/metadata'
                }
            }
        ]]

        mock_glue = MagicMock()
        mock_glue.get_paginator.return_value = mock_paginator
        mock_boto3_client.return_value = mock_glue

        with patch("src.main.python.common_data_sync.create_or_update_table") as mock_create_update, \
             patch("src.main.python.common_data_sync.sync_table_partitions") as mock_sync_parts, \
             patch("src.main.python.common_data_sync.delete_orphan_tables") as mock_delete_orphan:

            mock_create_update.return_value = None
            mock_sync_parts.return_value = None
            mock_delete_orphan.return_value = None

            common_data_sync.copy_tables()

        assert common_data_sync.summary_table['processed_tables'] == 1
        assert common_data_sync.summary_table['failed_tables'] == 0
        assert common_data_sync.summary_table['errors'] == []

if __name__ == "__main__":
    unittest.main()
