{{ 
  config(
    materialized = 'table',
    format = 'JSON',
    location = 's3a://your-bucket-name/acl_inventory/final_acl/',
    on_table_exists = 'drop'
  )
}}

{% set model_group_map = {
    "32010_seal_application": {
        "group": "ro.gmetrics",
        "privileges": ["SELECT"]
    },
    "32010_seal_bct": {
        "group": "ro.ccm",
        "privileges": ["SELECT"]
    }
} %}

SELECT '{{ generate_acl_json(model_group_map) }}' AS acl_json




{% macro generate_acl_json(model_group_map) %}
    {% set table_entries = [] %}

    {% for model, meta in model_group_map.items() %}
        {% set row = {
            "group": meta.group,
            "catalog": target.database,
            "schema": target.schema,
            "table": model,
            "privileges": meta.privileges
        } %}
        {% do table_entries.append(row) %}
    {% endfor %}

    {% set json_acl = {
        "tables": table_entries
    } %}

    {{ return(json_acl | tojson) }}
{% endmacro %}



   properties = {
      "format": "JSON",
      "serialization.lib": "org.openx.data.jsonserde.JsonSerDe"
    }
