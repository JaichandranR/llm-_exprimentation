{% macro generate_acl_json(model_group_map, graph) %}
  {% set rows = [] %}
  {% set available_models = [] %}

  {# Collect all model names from the graph #}
  {% for key in graph %}
    {% if key.startswith('model.') %}
      {% set available_models = available_models + [key] %}
    {% endif %}
  {% endfor %}

  {% do log("ALL AVAILABLE MODELS: " ~ available_models, info=True) %}

  {# Validate and emit ACL only for present models #}
  {% for model_name, meta in model_group_map.items() %}
    {% set model_in_graph = false %}

    {% for key in available_models %}
      {% if key.endswith('.' ~ model_name) %}
        {% set model_in_graph = true %}
        {% break %}
      {% endif %}
    {% endfor %}

    {% if model_in_graph %}
      {% set row = {
        "group": meta.group,
        "catalog": target.database,
        "schema": target.schema,
        "table": model_name,
        "privileges": meta.privileges
      } %}
      {% do rows.append(row) %}
    {% else %}
      {% do log("Skipping model '" ~ model_name ~ "' - not found in graph", info=True) %}
    {% endif %}
  {% endfor %}

  {% set full_json = {"tables": rows} %}
  {{ return(full_json | tojson) }}
{% endmacro %}







{% set model_group_map = {
  "32010_seal_application": {
    "group": "ro.gmetrics",
    "privileges": ["SELECT"]
  },
  "32010_seal_bct": {
    "group": "ro.ccm",
    "privileges": ["SELECT", "INSERT"]
  }
} %}

SELECT '{{ generate_acl_json(model_group_map, graph) }}' AS acl_json















{% set available_models = [] %}
{% for key, val in graph['nodes'].items() %}
  {% if 'resource_type' in val and val.resource_type == 'model' %}
    {% do available_models.append(val.name) %}
  {% endif %}
{% endfor %}

{% do log("ALL AVAILABLE MODELS: " ~ available_models, info=True) %}

SELECT 1 AS dummy






-- Capture model names from graph
{% set model_names = [] %}
{% for key in graph.keys() %}
  {% if key.startswith('model.') %}
    {% set model_name = key.split('.')[-1] %}
    {% do model_names.append(model_name) %}
  {% endif %}
{% endfor %}

-- Print available models
{% do log("Available models: " ~ model_names, info=True) %}

-- Use the models in your output
SELECT '{{ model_names | join(", ") }}' AS available_models








-- macros/acl_utils.sql

{% macro generate_acl_json(model_group_map) %}
  {% set rows = [] %}
  {% set all_models = graph.nodes.keys() | list %}
  {% do log("GRAPH DEBUG: " ~ all_models, info=True) %}

  {% for model_name, meta in model_group_map.items() %}
    {% set found = all_models | select('search', model_name) | list | length > 0 %}
    {% if found %}
      {% set row = {
        "group": meta.group,
        "catalog": target.database,
        "schema": target.schema,
        "table": model_name,
        "privileges": meta.privileges
      } %}
      {% do rows.append(row) %}
    {% else %}
      {% do log("Skipping model: " ~ model_name ~ " not found in graph", info=True) %}
    {% endif %}
  {% endfor %}

  {% set json_content = {"tables": rows} %}
  {{ return(json_content | tojson) }}
{% endmacro %}













{% macro generate_acl_json(model_group_map) %}
  {% set rows = [] %}
  {% set all_models = graph.nodes.keys() | list %}
  {% do log("Available models: " ~ all_models, info=True) %}

  {% for model_name, meta in model_group_map.items() %}
    {% set found = all_models | select('search', model_name) | list | length > 0 %}
    {% if found %}
      {% set row = {
        "group": meta.group,
        "catalog": target.database,
        "schema": target.schema,
        "table": model_name,
        "privileges": meta.privileges
      } %}
      {% do rows.append(row) %}
    {% else %}
      {% do log("Skipping model '" ~ model_name ~ "' - not found in graph", info=True) %}
    {% endif %}
  {% endfor %}

  {% set full_json = {"tables": rows} %}
  {{ return(full_json | tojson) }}
{% endmacro %}






{{ config(
  materialized='table',
  on_table_exists='drop',
  location='s3a://your-bucket/acl_inventory/json/',
  properties={"format": "'TEXTFILE'"}
) }}

{% set model_group_map = {
  "32010_seal_application": {"group": "ro.gmetrics", "privileges": ["SELECT"]},
  "32010_seal_bct": {"group": "ro.ccm", "privileges": ["SELECT"]}
} %}

SELECT '{{ generate_acl_json(model_group_map) }}' AS acl_json













{{ config(materialized='ephemeral') }}

{% do log("GRAPH DEBUG: " ~ graph.keys() | list, info=True) %}

SELECT 1




{{ config(materialized='ephemeral') }}

{% set model_group_map = {
  "32010_seal_application": {"group": "ro.gmetrics", "privileges": ["SELECT"]},
  "32010_seal_bct": {"group": "ro.ccm", "privileges": ["SELECT"]}
} %}

{{ generate_acl_json(model_group_map, graph) }}











{% macro generate_acl_json(model_group_map, graph) %}
  {% set rows = [] %}
  {% set available_models = [] %}

  {# Log all available models #}
  {% for key in graph %}
    {% if key.startswith('model.') %}
      {% do available_models.append(key) %}
    {% endif %}
  {% endfor %}
  {{ log("Available models: " ~ available_models, info=True) }}

  {% for model_name, meta in model_group_map.items() %}
    {% set model_in_graph = false %}

    {% for key in graph %}
      {% if key.startswith('model.') and key.endswith('.' ~ model_name) %}
        {% set model_in_graph = true %}
        {% break %}
      {% endif %}
    {% endfor %}

    {% if model_in_graph %}
      {% set row = {
        "group": meta.group,
        "catalog": target.database,
        "schema": target.schema,
        "table": model_name,
        "privileges": meta.privileges
      } %}
      {% do rows.append(row) %}
    {% else %}
      {{ log("Skipping model '" ~ model_name ~ "' - not found in graph", info=True) }}
    {% endif %}
  {% endfor %}

  {% set full_json = {"tables": rows} %}
  {{ return(full_json | tojson) }}
{% endmacro %}








{{ config(
  materialized='table',
  location='s3a://.../acl_inventory/json/',
  properties={"format": "'TEXTFILE'"}
) }}

{% set model_group_map = {
  "32010_seal_application": {"group": "ro.gmetrics", "privileges": ["SELECT"]},
  "32010_seal_bct": {"group": "ro.ccm", "privileges": ["SELECT"]}
} %}

SELECT '{{ generate_acl_json(model_group_map, graph) }}' AS acl_json
