{{
  config(
    materialized = 'table',
    format = 'JSON',
    location = 's3a://your-bucket-name/acl_inventory/trino_acl_json/',
    on_table_exists = 'drop'
  )
}}

{% set model_group_map = {
    "32010_seal_application": {
        "group": "ro.gmetrics",
        "privileges": ["SELECT"]
    },
    "32010_seal_bct": {
        "group": "ro.ccm",
        "privileges": ["SELECT", "INSERT"]
    }
} %}

SELECT *
FROM (
  VALUES
  {% for row in generate_acl_rows(model_group_map) %}
    (
      '{{ row.user }}',
      '{{ row.catalog }}',
      '{{ row.schema }}',
      '{{ row.table }}',
      ARRAY['{{ row.privileges | replace("','", "' , '") }}']
    ){% if not loop.last %},{% endif %}
  {% endfor %}
) AS t("user", "catalog", "schema", "table", "privileges")



{% macro generate_acl_rows(model_group_map) %}
    {% set rows = [] %}

    {% for model, meta in model_group_map.items() %}
        {% set quoted_privileges = "[" ~ meta.privileges | map('string') | join("','") ~ "]" %}
        {% set row = {
            "user": meta.group,
            "catalog": target.database,
            "schema": target.schema,
            "table": model,
            "privileges": quoted_privileges
        } %}
        {% do rows.append(row) %}
    {% endfor %}

    {{ return(rows) }}
{% endmacro %}
