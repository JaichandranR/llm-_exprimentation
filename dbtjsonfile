{% macro generate_acl_rows(model_group_map) %}
    {% set json_rows = [] %}

    {% for model, meta in model_group_map.items() %}
        {% if meta and meta.group and meta.privileges %}
            {% set row = {
                "user": meta.group,
                "catalog": target.database,
                "schema": target.schema,
                "table": model,
                "privileges": meta.privileges
            } %}
            {% do json_rows.append(row) %}
        {% endif %}
    {% endfor %}

    {{ return(json_rows) }}
{% endmacro %}


{{ 
  config(
    materialized = 'table',
    format = 'JSON',
    location = 's3a://your-bucket-name/acl_inventory/json/'
  )
}}

SELECT *
FROM (
  VALUES
  {% for row in generate_acl_rows(model_group_map) %}
    (
      '{{ row.user }}',
      '{{ row.catalog }}',
      '{{ row.schema }}',
      '{{ row.table }}',
      ARRAY{{ row.privileges | tojson }}
    ){% if not loop.last %},{% endif %}
  {% endfor %}
) AS t(user, catalog, schema, "table", privileges)
