    {# Step 5: Identify Jade table dynamically (no hardcoding) #}

    {% set jade_table_node = graph.nodes.values()
        | selectattr("resource_type", "equalto", "model")
        | selectattr("name", "equalto", "88057_jade_data_retention")
        | list
        | first %}

    {% if not jade_table_node %}
        {% do return("SELECT 'Jade retention table not found in graph' AS info") %}
    {% endif %}

    {% set jade_catalog = jade_table_node.database %}
    {% set jade_schema = jade_table_node.schema %}
    {% set jade_identifier = '"' ~ jade_table_node.name ~ '"' %}
    {% set jade_table_fqn = jade_catalog ~ '.' ~ jade_schema ~ '.' ~ jade_identifier %}

    {# Step 6: Build validation SELECT dynamically #}
    {% set jade_validation_select %}
        SELECT
            a.model_name,
            a.schema_name,
            a.database_name,
            a.rcc_code,
            a.purge_date_field,
            a.retention_value,
            CASE
                WHEN a.retention_value IS NULL THEN 'SKIPPED'
                WHEN upper(j.retentionclasscodestatus) = 'ACTIVE'
                     AND regexp_extract(a.retention_value, '([0-9]+)') = CAST(j.ruleperiod AS VARCHAR)
                     AND (
                         upper(regexp_extract(a.retention_value, '([a-zA-Z]+)')) = upper(j.periodunitcode)
                         OR (
                             (upper(regexp_extract(a.retention_value, '([a-zA-Z]+)')) = 'D' AND j.periodunitcode IN ('DAY','D'))
                             OR (upper(regexp_extract(a.retention_value, '([a-zA-Z]+)')) = 'M' AND j.periodunitcode IN ('MONTH','M'))
                             OR (upper(regexp_extract(a.retention_value, '([a-zA-Z]+)')) = 'Y' AND j.periodunitcode IN ('YEAR','Y'))
                         )
                     )
                    THEN 'PASS'
                ELSE 'FAIL'
            END AS validation_status,
            a.status,
            a.message,
            a.scan_timestamp
        FROM {{ this }} a
        LEFT JOIN {{ jade_table_fqn }} j
          ON upper(j.retentionclasscodestatus) = 'ACTIVE'
    {% endset %}

    {# Step 7: Replace table safely with validated version #}
    {% set validated_table = this.database ~ '.' ~ this.schema ~ '.' ~ this.identifier ~ '__validated' %}

    {% do run_query("DROP TABLE IF EXISTS " ~ validated_table) %}
    {% do run_query("CREATE TABLE " ~ validated_table ~ " AS " ~ jade_validation_select | replace('\n', ' ')) %}
    {% do run_query("DROP TABLE IF EXISTS " ~ this.database ~ '.' ~ this.schema ~ '.' ~ this.identifier) %}
    {% do run_query("ALTER TABLE " ~ validated_table ~ " RENAME TO " ~ this.database ~ '.' ~ this.schema ~ '.' ~ this.identifier) %}
