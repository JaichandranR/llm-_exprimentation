def setUp(self):
    self.mock_spark = MagicMock(spec=SparkSession)
    self.mock_spark.sql = MagicMock()
    self.mock_spark_context = MagicMock(spec=SparkContext)
    SparkContext._active_spark_context = self.mock_spark_context
    self.mock_spark_context._jsc = MagicMock()

    mock_builder = MagicMock()
    mock_builder.getOrCreate.return_value = self.mock_spark
    patcher = patch('src.main.python.iceberg_compaction.SparkSession.builder', return_value=mock_builder)
    self.addCleanup(patcher.stop)
    patcher.start()



def test_snapshot_expiration_and_orphan_file_removal_called(self):
    args = {
        'catalog_nm': 'test_catalog',
        'table_nm': 'test_table',
        'source_db': 'test_db',
        'expire_snapshots_day': '7',
        'skip_newest_partitions': '0'
    }
    iceberg_compaction.args = args

    iceberg_compaction.main()

    self.assertTrue(self.mock_spark.sql.called)
