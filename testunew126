    def test_capture_metrics_handles_join_and_view_creation(self):
        mock_df = MagicMock()
        self.mock_spark.table.return_value = mock_df
        mock_df.withColumn.return_value = mock_df
        mock_df.filter.return_value = mock_df
        mock_df.select.return_value = mock_df
        mock_df.distinct.return_value = mock_df
        mock_df.join.return_value = mock_df
        mock_df.createOrReplaceTempView.return_value = None
        mock_df.__getitem__.return_value.__ge__.return_value = MagicMock()
        mock_df.__getitem__.return_value.__lt__.return_value = MagicMock()
        mock_df.isin.return_value = MagicMock()

        iceberg_compaction.capture_metrics(
            self.mock_spark,
            "full_table",
            "metric_table",
            ["field_a"],
            485762,
            [485760]
        )

        mock_df.join.assert_called_once()
        mock_df.createOrReplaceTempView.assert_called_with("temp_metrics")
