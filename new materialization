-- macros/materializations/external_table.sql
{% materialization external_table, adapter='trino' %}
  {%- set location = config.get('location') %}
  {%- set format = config.get('format', 'parquet') %}
  {%- set identifier = model.alias %}
  {%- set fq_table_name = model.database ~ '.' ~ model.schema ~ '.' ~ identifier %}

  {% set create_statement %}
    CREATE TABLE IF NOT EXISTS {{ fq_table_name }}
    WITH (
      location = '{{ location }}',
      format = '{{ format }}'
    )
    AS
    {{ sql }}
  {% endset %}

  {% do log("Running external CTAS:", info=True) %}
  {% do log("Create statement:\n" ~ create_statement, info=True) %}
  {% do run_query(create_statement) %}

  {% set relation = api.Relation.create(
      database=model.database,
      schema=model.schema,
      identifier=model.alias
  ) %}

  {{ return({'relations': [relation]}) }}
{% endmaterialization %}
