{% materialization external_table, default %}
  {#-- Load configurations --#}
  {% set prefix = config.get("prefix", "") %}
  {% set format = config.get("format", "parquet") %}

  {#-- Load environment and schema name --#}
  {% set env = var("env") %}
  {% set schema = model.schema %}

  {#-- Handle optional _jules suffix in schema name --#}
  {% set base_schema = schema[:-6] if schema.endswith("_jules") else schema %}

  {#-- Build the variable name to look up in dbt_project.yml --#}
  {% set schema_key = env ~ "_" ~ base_schema ~ "_s3location" %}
  {% set schema_location = var(schema_key) %}

  {#-- Append trailing slash if missing --#}
  {% if not schema_location.endswith("/") %}
    {% set schema_location = schema_location ~ "/" %}
  {% endif %}

  {#-- Compose final path --#}
  {% set full_location = schema_location ~ model.name %}

  {#-- Generate the fully qualified table name --#}
  {% set fq_table_name = model.database ~ '.' ~ model.schema ~ '.' ~ model.name %}

  {#-- Construct CREATE TABLE statement --#}
  {% set create_statement %}
    CREATE TABLE IF NOT EXISTS {{ fq_table_name }}
    WITH (
      location = '{{ full_location }}',
      format = '{{ format }}'
    )
    AS
    {{ sql }}
  {% endset %}

  {% call statement('main', fetch_result=False) %}
    {{ create_statement }}
  {% endcall %}

  {{ return({"relations": [this]}) }}
{% endmaterialization %}
