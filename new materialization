-- macros/materializations/external.sql
{% materialization external, adapter='trino' %}

  {# Read model SQL as string #}
  {% set sql = compiled_sql %}

  {% set identifier = model.identifier %}
  {% set schema = model.schema %}
  {% set database = model.database %}
  {% set fq_table = database ~ '.' ~ schema ~ '.' ~ identifier %}
  
  {% set location = config.get('location') %}
  {% set format = config.get('format', 'parquet') %}

  {% set create_sql %}
    CREATE TABLE IF NOT EXISTS {{ fq_table }}
    WITH (
      location = '{{ location }}',
      format = '{{ format }}'
    )
    AS
    {{ sql }}
  {% endset %}

  {{ log("Running external CTAS:\n" ~ create_sql, info=True) }}
  {{ run_query(create_sql) }}

  {{ return({'relations': [this]}) }}

{% endmaterialization %}







{{ 
  config(
    materialized = 'external',
    format = 'parquet',
    location = 's3://your-bucket/your-folder/'
  )
}}

with cleaned as (
  select
    a.creation_date_displayname,
    a.last_updated_date,
    a.last_updated_username
  from archer.dbo.application as a
  limit 10
)

select * from cleaned
