{% materialization external_table, adapter='trino' %}

  {% set location = config.get('location') %}
  {% set format = config.get('format', 'parquet') %}
  {% set identifier = model['alias'] %}
  {% set fq_table_name = model.database ~ '.' ~ model.schema ~ '.' ~ identifier %}

  {% set create_statement %}
    CREATE TABLE IF NOT EXISTS {{ fq_table_name }}
    WITH (
      location = '{{ location }}',
      format = '{{ format }}'
    )
    AS {{ sql }}
  {% endset %}

  {{ log("Running external CTAS:", info=True) }}
  {{ log("Create statement: " ~ create_statement, info=True) }}
  {{ run_query(create_statement) }}

  {% set compiled_code = sql %}
  {% do return({'relations': [this], 'compiled_code': compiled_code}) %}

{% endmaterialization %}
