id: trp_application_risk_info
namespace: core-services

tasks:
  # ðŸ”¹ TODAY RUN (full-refresh, only run once per day)
  - id: today_trp_run
    type: dbt.v2.Run
    command: 'dbt run -m trp_application_risk_info --full-refresh --vars ''{"CALCULATION_DATE": "{{ now() | date("yyyy-MM-dd") }}"}'''

  - id: today_raw_run
    type: dbt.v2.Run
    command: 'dbt run -m raw_103662_trp_application_risk_info --full-refresh'

  # ðŸ”¹ HISTORICAL 6-MONTH BACKFILLS (cache-selected-only, adjusted logic)
  - id: m1_trp_run
    type: dbt.v2.Run
    command: 'dbt run -m trp_application_risk_info --cache-selected-only --vars ''{"CALCULATION_DATE": "{% if now() | date("dd") != "01" %}{{ now() | date("yyyy-MM-01") }}{% else %}{{ now() | dateAdd(-1, "MONTHS") | date("yyyy-MM-01") }}{% endif %}"}'''

  - id: m1_raw_run
    type: dbt.v2.Run
    command: 'dbt run -m raw_103662_trp_application_risk_info --cache-selected-only'

  - id: m2_trp_run
    type: dbt.v2.Run
    command: 'dbt run -m trp_application_risk_info --cache-selected-only --vars ''{"CALCULATION_DATE": "{% if now() | date("dd") != "01" %}{{ now() | dateAdd(-1, "MONTHS") | date("yyyy-MM-01") }}{% else %}{{ now() | dateAdd(-2, "MONTHS") | date("yyyy-MM-01") }}{% endif %}"}'''

  - id: m2_raw_run
    type: dbt.v2.Run
    command: 'dbt run -m raw_103662_trp_application_risk_info --cache-selected-only'

  - id: m3_trp_run
    type: dbt.v2.Run
    command: 'dbt run -m trp_application_risk_info --cache-selected-only --vars ''{"CALCULATION_DATE": "{% if now() | date("dd") != "01" %}{{ now() | dateAdd(-2, "MONTHS") | date("yyyy-MM-01") }}{% else %}{{ now() | dateAdd(-3, "MONTHS") | date("yyyy-MM-01") }}{% endif %}"}'''

  - id: m3_raw_run
    type: dbt.v2.Run
    command: 'dbt run -m raw_103662_trp_application_risk_info --cache-selected-only'

  - id: m4_trp_run
    type: dbt.v2.Run
    command: 'dbt run -m trp_application_risk_info --cache-selected-only --vars ''{"CALCULATION_DATE": "{% if now() | date("dd") != "01" %}{{ now() | dateAdd(-3, "MONTHS") | date("yyyy-MM-01") }}{% else %}{{ now() | dateAdd(-4, "MONTHS") | date("yyyy-MM-01") }}{% endif %}"}'''

  - id: m4_raw_run
    type: dbt.v2.Run
    command: 'dbt run -m raw_103662_trp_application_risk_info --cache-selected-only'

  - id: m5_trp_run
    type: dbt.v2.Run
    command: 'dbt run -m trp_application_risk_info --cache-selected-only --vars ''{"CALCULATION_DATE": "{% if now() | date("dd") != "01" %}{{ now() | dateAdd(-4, "MONTHS") | date("yyyy-MM-01") }}{% else %}{{ now() | dateAdd(-5, "MONTHS") | date("yyyy-MM-01") }}{% endif %}"}'''

  - id: m5_raw_run
    type: dbt.v2.Run
    command: 'dbt run -m raw_103662_trp_application_risk_info --cache-selected-only'

  - id: m6_trp_run
    type: dbt.v2.Run
    command: 'dbt run -m trp_application_risk_info --cache-selected-only --vars ''{"CALCULATION_DATE": "{% if now() | date("dd") != "01" %}{{ now() | dateAdd(-5, "MONTHS") | date("yyyy-MM-01") }}{% else %}{{ now() | dateAdd(-6, "MONTHS") | date("yyyy-MM-01") }}{% endif %}"}'''

  - id: m6_raw_run
    type: dbt.v2.Run
    command: 'dbt run -m raw_103662_trp_application_risk_info --cache-selected-only'
