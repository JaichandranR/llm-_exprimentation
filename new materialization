{% materialization external_table, default %}

  {% call statement('main', fetch_result=False) %}
    {%- set location = config.get('location') %}
    {%- set format = config.get('format', 'parquet') %}

    {# Quote identifier if it starts with a digit -#}
    {%- set identifier = model.alias %}
    {%- if identifier[0].isdigit() %}
      {%- set identifier = '"' ~ identifier ~ '"' %}
    {%- endif %}

    {%- set fq_table_name = model.database ~ '.' ~ model.schema ~ '.' ~ identifier %}

    {%- set create_statement %}
      CREATE TABLE IF NOT EXISTS {{ fq_table_name }}
      WITH (
        location = '{{ location }}',
        format = '{{ format }}'
      )
      AS
      {{ sql }}
    {%- endset %}

    {{ log("Running external CTAS:", info=True) }}
    {{ log("Create statement: \n" ~ create_statement, info=True) }}

    {% do run_query(create_statement) %}

  {% endcall %}

  {{ return({'relations': [this]}) }}

{% endmaterialization %}
