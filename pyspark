id: trp_application_risk_info
namespace: core-services

tasks:
  # ðŸ”¹ TODAY (with full refresh)
  - id: today_trp_run
    type: dbt.v2.Run
    command: 'dbt run -m trp_application_risk_info --full-refresh --vars ''{"CALCULATION_DATE": "{{ now() | date("yyyy-MM-dd") }}"}'''

  - id: today_raw_run
    type: dbt.v2.Run
    command: 'dbt run -m raw_103662_trp_application_risk_info --full-refresh'

  # ðŸ”¹ PREPARE 6 x 1ST-OF-MONTH DATES
  - id: prepare_6_months_dates
    type: io.kestra.core.tasks.debugs.Return
    format: >
      {% set month_start = now() | date("yyyy-MM-01") %}
      {% set today = now() | date("yyyy-MM-dd") %}
      {% set include_current = (today > month_start) %}
      {
        "months": [
          {% if include_current %}
            "{{ now() | date("yyyy-MM-01") }}",
            "{{ now() | dateAdd(-1, "MONTHS") | date("yyyy-MM-01") }}",
            "{{ now() | dateAdd(-2, "MONTHS") | date("yyyy-MM-01") }}",
            "{{ now() | dateAdd(-3, "MONTHS") | date("yyyy-MM-01") }}",
            "{{ now() | dateAdd(-4, "MONTHS") | date("yyyy-MM-01") }}",
            "{{ now() | dateAdd(-5, "MONTHS") | date("yyyy-MM-01") }}"
          {% else %}
            "{{ now() | dateAdd(-1, "MONTHS") | date("yyyy-MM-01") }}",
            "{{ now() | dateAdd(-2, "MONTHS") | date("yyyy-MM-01") }}",
            "{{ now() | dateAdd(-3, "MONTHS") | date("yyyy-MM-01") }}",
            "{{ now() | dateAdd(-4, "MONTHS") | date("yyyy-MM-01") }}",
            "{{ now() | dateAdd(-5, "MONTHS") | date("yyyy-MM-01") }}",
            "{{ now() | dateAdd(-6, "MONTHS") | date("yyyy-MM-01") }}"
          {% endif %}
        ]
      }

  # ðŸ”¹ STATIC RUNS FOR PREVIOUS MONTHS (no full refresh)
  - id: m1_trp_run
    type: dbt.v2.Run
    command: 'dbt run -m trp_application_risk_info --cache-selected-only --vars ''{"CALCULATION_DATE": "{{ outputs.prepare_6_months_dates.value.months[0] }}"}'''

  - id: m1_raw_run
    type: dbt.v2.Run
    command: 'dbt run -m raw_103662_trp_application_risk_info --cache-selected-only'

  - id: m2_trp_run
    type: dbt.v2.Run
    command: 'dbt run -m trp_application_risk_info --cache-selected-only --vars ''{"CALCULATION_DATE": "{{ outputs.prepare_6_months_dates.value.months[1] }}"}'''

  - id: m2_raw_run
    type: dbt.v2.Run
    command: 'dbt run -m raw_103662_trp_application_risk_info --cache-selected-only'

  - id: m3_trp_run
    type: dbt.v2.Run
    command: 'dbt run -m trp_application_risk_info --cache-selected-only --vars ''{"CALCULATION_DATE": "{{ outputs.prepare_6_months_dates.value.months[2] }}"}'''

  - id: m3_raw_run
    type: dbt.v2.Run
    command: 'dbt run -m raw_103662_trp_application_risk_info --cache-selected-only'

  - id: m4_trp_run
    type: dbt.v2.Run
    command: 'dbt run -m trp_application_risk_info --cache-selected-only --vars ''{"CALCULATION_DATE": "{{ outputs.prepare_6_months_dates.value.months[3] }}"}'''

  - id: m4_raw_run
    type: dbt.v2.Run
    command: 'dbt run -m raw_103662_trp_application_risk_info --cache-selected-only'

  - id: m5_trp_run
    type: dbt.v2.Run
    command: 'dbt run -m trp_application_risk_info --cache-selected-only --vars ''{"CALCULATION_DATE": "{{ outputs.prepare_6_months_dates.value.months[4] }}"}'''

  - id: m5_raw_run
    type: dbt.v2.Run
    command: 'dbt run -m raw_103662_trp_application_risk_info --cache-selected-only'

  - id: m6_trp_run
    type: dbt.v2.Run
    command: 'dbt run -m trp_application_risk_info --cache-selected-only --vars ''{"CALCULATION_DATE": "{{ outputs.prepare_6_months_dates.value.months[5] }}"}'''

  - id: m6_raw_run
    type: dbt.v2.Run
    command: 'dbt run -m raw_103662_trp_application_risk_info --cache-selected-only'
