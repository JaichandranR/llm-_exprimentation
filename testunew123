import json
import yaml
from pathlib import Path

# Define project root based on this script's location
BASE_DIR = Path(__file__).resolve().parent.parent
CATALOG_PATH = BASE_DIR / "target" / "catalog.json"
OUTPUT_MD_PATH = BASE_DIR / "models" / "overview.md"

def main():
    if not CATALOG_PATH.exists():
        raise FileNotFoundError(f"catalog.json not found at: {CATALOG_PATH}")

    with open(CATALOG_PATH) as f:
        catalog = json.load(f)

    tables = []
    database = ''
    schema = ''

    for node in catalog.get("nodes", {}).values():
        metadata = node.get("metadata", {})
        schema_name = metadata.get("schema", "")
        if schema_name.startswith("common_data") and schema_name != "common_data_raw":
            tables.append({"name": metadata.get("name")})
            database = metadata.get("database", database)
            schema = schema_name

    yaml_obj = {
        "version": 2,
        "sources": [
            {
                "name": "common_reference_iceberg",
                "database": database or "cosmos_nonhcd_iceberg",
                "schema": schema or "common_data",
                "tables": tables or [{"name": "example_table"}]
            }
        ]
    }

    md_content = "## Auto-generated Source YAML\n\n```yaml\n"
    md_content += yaml.dump(yaml_obj, sort_keys=False)
    md_content += "```\n"

    with open(OUTPUT_MD_PATH, "w") as out:
        out.write(md_content)

    print(f"âœ… overview.md successfully written to: {OUTPUT_MD_PATH}")

if __name__ == "__main__":
    main()
