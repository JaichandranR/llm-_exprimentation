{{ config(materialized='view') }}

with source_data as (
    select
        cast(json_parse(raw) as json) as parsed_json,
        CosmosIngestedAt
    from {{ ref('raw_103662_trp_application_risk_info') }}
),

exploded as (
    select
        json_extract_scalar(parsed_json, '$.calculationDate') as calculation_date,
        json_extract_scalar(parsed_json, '$.ruleVersion') as rule_version,
        CosmosIngestedAt,
        json_extract_scalar(app_elem, '$.applicationId') as application_id,
        json_format(json_extract(app_elem, '$.statusStreakMap')) as status_streak_raw
    from source_data
    cross join unnest(
        cast(json_extract(parsed_json, '$.applicationRiskProfile') as array(json))
    ) as t(app_elem)
)

select
    calculation_date,
    rule_version,
    application_id,
    CosmosIngestedAt,
    cast(regexp_extract(status_streak_raw, '"CD-NE"\s*:\s*"?(\\d+)"?', 1) as integer) as cd_ne,
    cast(regexp_extract(status_streak_raw, '"CP-NE"\s*:\s*"?(\\d+)"?', 1) as integer) as cp_ne,
    cast(regexp_extract(status_streak_raw, '"CR-NE"\s*:\s*"?(\\d+)"?', 1) as integer) as cr_ne,
    cast(regexp_extract(status_streak_raw, '"FM-CHI"\s*:\s*"?(\\d+)"?', 1) as integer) as fm_chi,
    cast(regexp_extract(status_streak_raw, '"TA-NE"\s*:\s*"?(\\d+)"?', 1) as integer) as ta_ne,
    cast(regexp_extract(status_streak_raw, '"VE1"\s*:\s*"?(\\d+)"?', 1) as integer) as ve1,
    cast(regexp_extract(status_streak_raw, '"AF1"\s*:\s*"?(\\d+)"?', 1) as integer) as af1
from exploded
