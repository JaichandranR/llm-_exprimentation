id: trp_application_risk_info
namespace: core-services

tasks:
  - id: prepare_dates
    type: io.kestra.core.tasks.debugs.Return
    format: >
      [
        {% set current_dates = [] %}
        {% set today = now() %}
        {% set dow_today = today | date('u') %}

        {% if dow_today != '6' and dow_today != '7' %}
          "{{ today | date('yyyy-MM-dd') }}",
        {% endif %}

        "{{ today | date('yyyy-MM-01') }}",

        {% for i in range(1, 7) %}
          {% set past_date = dateAdd(-i, 'MONTHS') %}
          {% set dow = past_date | date('u') %}
          {% if dow != '6' and dow != '7' %}
            "{{ past_date | date('yyyy-MM-01') }}",
          {% endif %}
        {% endfor %}
      ]

  - id: debug_output
    type: io.kestra.plugin.core.log.Log
    message: "Prepare Dates Output: {{ outputs.prepare_dates }}"

  - id: log_dates_loop
    type: io.kestra.core.tasks.flows.EachSequential
    value: "{{ outputs.prepare_dates.value }}"
    tasks:
      - id: log_date
        type: io.kestra.plugin.core.log.Log
        message: "Processing date: {{ taskrun.value }}"
