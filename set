id: trp_application_risk_info
namespace: core-services

tasks:
  - id: prepare_dates
    type: io.kestra.plugin.scripts.python.Script
    inputFiles: {}
    script: |
      from datetime import datetime
      from dateutil.relativedelta import relativedelta

      today = datetime.today()
      dates = [today.strftime("%Y-%m-%d")] + [
          (today - relativedelta(months=i)).replace(day=1).strftime("%Y-%m-%d") for i in range(1, 7)
      ]

      import json
      print(json.dumps({ "dates": dates }))
    outputFiles:
      - dates.json

  - id: read_dates
    type: io.kestra.core.tasks.storages.LocalFiles
    files:
      - id: extracted
        path: dates.json

  - id: dbt_loop
    type: io.kestra.core.tasks.flows.EachSequential
    value: "{{ outputs.read_dates.extracted | jsonParse | jsonPath('$.dates') }}"
    tasks:
      - id: trp_application_risk_info_apitable_query
        type: dbt.v2.Run
        command: >
          dbt run -m trp_application_risk_info --cache-selected-only --vars '{{"CALCULATION_DATE": "{{ taskrun.value }}"}}'

      - id: trp_application_risk_info_apitable_query_response
        type: kestra.plugin.core.log.Log
        message: output {{outputs.trp_application_risk_info_apitable_query.apiResponse}}

      - id: raw_103662_trp_application_risk_info_query
        type: dbt.v2.Run
        command: dbt run -m raw_103662_trp_application_risk_info --cache-selected-only

      - id: raw_103662_trp_application_risk_info_query_response
        type: kestra.plugin.core.log.Log
        message: output {{outputs.raw_103662_trp_application_risk_info_query.apiResponse}}
