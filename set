id: trp_application_risk_info
namespace: core-services

tasks:
  - id: prepare_dates
    type: io.kestra.plugin.scripts.python.Script
    timeout: PT1M
    inputFiles: {}
    script: |
      from datetime import datetime

      today = datetime.today()
      dates = [today.strftime("%Y-%m-%d")]

      for i in range(1, 7):
          month = today.month - i
          year = today.year
          if month <= 0:
              month += 12
              year -= 1
          date = datetime(year, month, 1)
          dates.append(date.strftime("%Y-%m-%d"))

      import json
      print(json.dumps({ "dates": dates }))

  - id: dbt_loop
    type: io.kestra.core.tasks.flows.EachSequential
    value: "{{ outputs.prepare_dates | jsonParse | jsonPath('$.dates') }}"
    tasks:
      - id: dbt_run_with_var
        type: dbt.v2.Run
        command: >
          dbt run -m trp_application_risk_info --cache-selected-only --vars '{{"CALCULATION_DATE": "{{ taskrun.value }}"}}'

      - id: dbt_run_standard
        type: dbt.v2.Run
        command: dbt run -m raw_103662_trp_application_risk_info --cache-selected-only
