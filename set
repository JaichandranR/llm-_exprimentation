- id: prepare_dates
  type: io.kestra.core.tasks.debugs.Return
  format: >
    [
    {% set index = 0 %}
    {% set first = true %}
    {% if now() | date('u') != '6' and now() | date('u') != '7' %}
      {% if not first %},{% endif %}{ "index": {{ index }}, "date": "{{ now() | date('yyyy-MM-dd') }}" }
      {% set index = index + 1 %}{% set first = false %}
    {% endif %}
    {% set m1 = now() | date('yyyy-MM-01') %}
    {% if m1 | date('u') != '6' and m1 | date('u') != '7' %}
      {% if not first %},{% endif %}{ "index": {{ index }}, "date": "{{ m1 }}" }
      {% set index = index + 1 %}{% set first = false %}
    {% endif %}
    {% for i in range(1, 7) %}
      {% set d = now() | dateAdd(-i, 'MONTHS') | date('yyyy-MM-01') %}
      {% if d | date('u') != '6' and d | date('u') != '7' %}
        {% if not first %},{% endif %}{ "index": {{ index }}, "date": "{{ d }}" }
        {% set index = index + 1 %}{% set first = false %}
      {% endif %}
    {% endfor %}
    ]


- id: log_date_loop
  type: io.kestra.core.tasks.flows.EachSequential
  value: "{{ outputs.prepare_dates.value }}"
  tasks:
    - id: log
      type: io.kestra.plugin.core.log.Log
      message: "Running for {{ taskrun.value.date }} (index={{ taskrun.value.index }})"

    - id: if_first
      type: io.kestra.core.tasks.flows.If
      condition: "{{ taskrun.value.index == 0 }}"
      then:
        - id: log_full_refresh
          type: io.kestra.plugin.core.log.Log
          message: "‚úÖ This is first loop: simulate full-refresh"

    - id: standard_log
      type: io.kestra.plugin.core.log.Log
      message: "üîÅ Normal execution for {{ taskrun.value.date }}"
