id: trp_application_risk_info
namespace: core-services

tasks:
  - id: prepare_dates
    type: io.kestra.core.tasks.debugs.Return
    format:
      - {% set dates = [] %}
        {% set today = now() | date('yyyy-MM-dd') %}
        {% set m1 = now() | date('yyyy-MM-01') %}
        {% do dates.append({"index": 0, "date": today}) %}
        {% do dates.append({"index": 1, "date": m1}) %}
        {% for i in range(1, 7) %}
          {% set d = now() | dateAdd(-i, 'MONTHS') | date('yyyy-MM-01') %}
          {% do dates.append({"index": i + 1, "date": d}) %}
        {% endfor %}
        {{ dates }}

  - id: debug_output
    type: io.kestra.plugin.core.log.Log
    message: "Prepare Dates Output: {{ outputs.prepare_dates }}"

  - id: log_dates_loop
    type: io.kestra.core.tasks.flows.EachSequential
    value: "{{ outputs.prepare_dates }}"
    tasks:
      - id: log_date
        type: io.kestra.plugin.core.log.Log
        message: "Processing index: {{ taskrun.value.index }}, date: {{ taskrun.value.date }}"
