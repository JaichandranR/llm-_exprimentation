üìß Email Draft to Producer Team (Updated With New Understanding)

Subject: Action Needed: Iceberg Compaction Failures Due to Writes in Compaction Partitions

Hi Team,

We have been investigating the recent Iceberg compaction failures, and we have identified the exact root cause. I am sharing the details below so we can realign on the correct ingestion behavior going forward.

Summary of the Issue

The compaction job is failing because the Flink producer job is writing new records into the same hour partitions that the compaction job is actively compacting. Iceberg requires a stable partition during compaction, and any writes to that partition cause the manifest rewrite to fail.

This behavior was not part of our original ingestion contract.

1. Original Design Agreement

When this pipeline was onboarded, we agreed on the following:

Producer will only write into:

Current hour (H)

Previous hour (H-1)

Compaction will run only on partitions older than H-4

This ensured the following:

Compaction never touches partitions receiving new data

No multi-writer conflicts

Stable Iceberg snapshots

Successful compaction across all older partitions

This setup worked perfectly until recently.

2. What Changed

We now see the producer is writing into multiple past-hour partitions, such as:

H-2

H-3

H-4

H-5

These are exactly the partitions the compaction framework is processing. Because compaction rewrites data files and manifests, any concurrent writes invalidate the snapshot Iceberg is working on.

3. Why Compaction Fails (Technical Explanation)

During compaction, Iceberg does:

Reads the snapshot for the target partition

Rewrites data files and manifests

Validates before commit:
‚ÄúHas this partition changed since I started?‚Äù

If a new record arrives in that partition while compaction is running, Iceberg detects the change and aborts the commit to avoid corruption.
This leads to the exact error we are seeing:

ValidationException: Deleted manifest ... could not be found in latest snapshot


This is expected and correct Iceberg behavior.

4. Important Clarification

Only the active compaction partition is affected.

Older partitions that were already compacted remain fully stable and untouched

There is no impact on previously compacted partitions

Only the hour where Flink writes while compaction runs will fail

5. Required Action

To restore stability, the producer pipeline must return to the original ingestion contract:

‚úî Only write into current and previous hour partitions (H and H-1)

If writing into older partitions is now expected due to:

late data

timestamp changes

watermark or event-time lag

replays/backfills

pipeline refactor

Please inform us so we can update the compaction strategy and skip logic accordingly.

6. What Happens If Producer Avoids Compaction Partitions

If the producer avoids writing into the hour being compacted:

Compaction will always complete successfully

No conflicts will occur

No manifest rewrite failures

Table optimization remains healthy

This returns the system to the original, stable operating state.

Please review and confirm the expected write window so we can update our compaction rules or ingestion assumptions accordingly. We appreciate your help in resolving this issue quickly.

Thanks,
