{% macro create_external_table(model, sql) %}
  {% set location = config.get('location') %}
  {% set format = config.get('format', 'parquet') %}

  {# Split catalog.schema.identifier from relation object #}
  {% set full_id = model.identifier %}
  {% set full_schema = model.schema %}
  {% set full_database = model.database %}

  {# Quote only the identifier (table name), not schema/catalog #}
  {% set model_unquoted = full_database ~ '.' ~ full_schema ~ '."' ~ full_id ~ '"' %}

  {% set create_statement %}
    CREATE TABLE IF NOT EXISTS {{ model_unquoted }}
    WITH (
      location = '{{ location }}',
      format = '{{ format }}'
    )
    AS
    {{ sql }}
  {% endset %}

  {{ log("Running custom external CTAS for Trino", info=True) }}
  {{ log("Create statement: " ~ create_statement, info=True) }}
  {{ run_query(create_statement) }}

  {{ return({'relations': [model]}) }}
{% endmacro %}
