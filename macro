with source_data as (
  select
    cast(json_parse(raw) as json) as parsed_json
  from {{ ref('raw_103662_trp_application_risk_info') }}
),

exploded as (
  select
    json_extract_scalar(parsed_json, '$.calculationDate') as calculation_date,
    json_extract_scalar(parsed_json, '$.ruleVersion') as rule_version,
    app_elem
  from source_data
  cross join unnest(
    cast(json_extract(parsed_json, '$.applicationRiskProfile') as array(json))
  ) AS t (app_elem)
)

select
  calculation_date,
  rule_version,
  json_extract_scalar(app_elem, '$.applicationId') as application_id,
  json_extract_scalar(app_elem, '$.overallTechRiskStatus') as overall_tech_risk_status,
  json_extract_scalar(app_elem, '$.CyberPreventativeStatus') as cyber_preventative_status,
  json_extract_scalar(app_elem, '$.CyberDetectiveStatus') as cyber_detective_status
from exploded
