with source_data as (
  select
    cast(json_parse(raw) as json) as parsed_json
  from {{ ref('raw_103662_trp_application_risk_info') }}
),

flattened as (
  select
    json_extract_scalar(parsed_json, '$.calculationDate') as calculation_date,
    json_extract_scalar(parsed_json, '$.ruleVersion') as rule_version,
    json_extract(json_value, '$') as app_risk_profile
  from source_data,
       unnest(cast(json_extract(parsed_json, '$.applicationRiskProfile') as array(json))) AS t (json_value)
)

select
  calculation_date,
  rule_version,
  json_extract_scalar(app_risk_profile, '$.applicationId') as application_id,
  json_extract_scalar(app_risk_profile, '$.overallTechRiskStatus') as overall_tech_risk_status,
  json_extract_scalar(app_risk_profile, '$.CyberPreventativeStatus') as cyber_preventative_status,
  json_extract_scalar(app_risk_profile, '$.CyberDetectiveStatus') as cyber_detective_status
from flattened
