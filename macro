{% macro create_external_table(model, sql) %}
  {% set location = config.get('location') %}
  {% set format = config.get('format', 'parquet') %}

  {# Always fully quote identifiers since EXECUTE IMMEDIATE will treat it as string #}
  {% set fq_table_name = '"' ~ model.database ~ '"' ~ '.' ~ '"' ~ model.schema ~ '"' ~ '.' ~ '"' ~ model.identifier ~ '"' %}

  {# Escape single quotes inside SQL string #}
  {% set escaped_sql = sql.replace("'", "''") %}

  {% set create_statement %}
    EXECUTE IMMEDIATE '
      CREATE TABLE {{ fq_table_name }}
      WITH (
        location = ''{{ location }}'',
        format = ''{{ format }}''
      )
      AS
      {{ escaped_sql }}
    '
  {% endset %}

  {{ log("Running CTAS via EXECUTE IMMEDIATE for Trino", info=True) }}
  {{ log("Query: " ~ create_statement, info=True) }}
  {{ run_query(create_statement) }}

  {{ return({'relations': [model]}) }}
{% endmacro %}
