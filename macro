{% macro create_external_table(model, sql) %}
  {% set location = config.get('location') %}
  {% set format = config.get('format', 'parquet') %}

  {# Validate SQL is not empty #}
  {% if not sql | trim %}
    {{ exceptions.raise_compiler_error("SQL block for CTAS is empty. Cannot create external table.") }}
  {% endif %}

  {# Quote identifier only if needed (starts with digit) #}
  {% set identifier = model.identifier %}
  {% if identifier[0].isdigit() %}
    {% set identifier = '"' ~ identifier ~ '"' %}
  {% endif %}

  {# Build full table name: catalog.schema.identifier #}
  {% set fq_table_name = model.database ~ '.' ~ model.schema ~ '.' ~ identifier %}

  {# Construct CTAS statement #}
  {% set create_statement %}
    CREATE TABLE IF NOT EXISTS {{ fq_table_name }}
    WITH (
      location = '{{ location }}',
      format = '{{ format }}'
    )
    AS
    {{ sql }}
  {% endset %}

  {{ log("Running custom external CTAS for Trino", info=True) }}
  {{ log("Create statement: " ~ create_statement, info=True) }}

  {# Attempt execution #}
  {% set result = run_query(create_statement) %}

  {# Log result for inspection â€” avoid relying on return value #}
  {{ log("Query execution result: " ~ result, info=True) }}

  {# Return model relation to prevent DBT failure #}
  {{ return({'relations': [model]}) }}
{% endmacro %}
