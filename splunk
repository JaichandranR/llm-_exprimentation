index=cloudtraillogs_aws_audit meta_account_no=7045454537057 source="90177"
| search "fnd_fct_stg_review"
| spath
| eval principalId = coalesce('userIdentity.sessionContext.sessionIssuer.principalId','userIdentity.principalId')
| eval role_arn    = coalesce('userIdentity.sessionContext.sessionIssuer.arn','userIdentity.arn')
| rex field=role_arn "arn:aws:iam::\d+:role/(?<role_name>[^/]+)"
| stats count min(_time) as first_seen max(_time) as last_seen by principalId role_name role_arn eventName
| convert ctime(first_seen) ctime(last_seen)
| sort -count

index=cloudtraillogs_aws_audit meta_account_no=7045454537057 source="90177"
| search "fnd_fct_stg_review"
| spath
| eval principalId = coalesce('userIdentity.sessionContext.sessionIssuer.principalId','userIdentity.principalId')
| eval role_arn    = coalesce('userIdentity.sessionContext.sessionIssuer.arn','userIdentity.arn')
| rex field=role_arn "arn:aws:iam::\d+:role/(?<role_name>[^/]+)"
| stats values(role_arn) as role_arns values(role_name) as role_names values(principalId) as principal_ids

index=cloudtraillogs_aws_audit meta_account_no=7045454537057 source="90177"
| search "fnd_fct_stg_review"
| spath
| table _time eventName userIdentity.type userIdentity.principalId userIdentity.sessionContext.sessionIssuer.arn userIdentity.arn sourceIPAddress
| sort 0 -_time

index=cloudtraillogs_aws_audit meta_account_no=7045454537057 source="90177"
| search "fnd_fct_stg_review"
| spath
| search eventSource="glue.amazonaws.com"
| search eventName IN (
    GetTable, GetTableVersion, GetTableVersions,
    CreateTable, UpdateTable, DeleteTable,
    GetPartitions, CreatePartition, UpdatePartition, DeletePartition,
    BatchCreatePartition, BatchDeletePartition, BatchUpdatePartition
)
| eval table_name=coalesce('requestParameters.name','requestParameters.tableName',
                           'requestParameters.table.name','requestParameters.tableInput.name')
| where table_name="fnd_fct_stg_review"
| eval principalId_full='userIdentity.principalId'                                   /* e.g., AROA...:K053721@... */
| eval roleArn=coalesce('userIdentity.sessionContext.sessionIssuer.arn','userIdentity.arn')
| rex field=roleArn "arn:aws:iam::\d+:role/(?<role_name>[^/]+)"
| table _time eventName table_name principalId_full role_name roleArn sourceIPAddress
| sort 0 -_time

index=cloudtraillogs_aws_audit meta_account_no=7045454537057 source="90177"
| search eventSource="s3.amazonaws.com"
| spath
| mvexpand resources{}.ARN
| rex field=resources{}.ARN "arn:aws:s3:::(?<res_bucket>[^/]+)(?:/(?<res_key>.*))?"
| eval bucket = coalesce('requestParameters.bucketName', res_bucket)
| eval key    = coalesce('requestParameters.key','additionalEventData.objectKey',res_key,'requestParameters.x-amz-copy-source')
| eval key    = urldecode(key)
| eval target_bucket="app-id-90177-dep-id-114232-uu-id-plx8m7sl1nf0", target_prefix="fnd_fct_stg_review"
| where bucket=target_bucket AND like(key, target_prefix . "%")
| eval principalId_full='userIdentity.principalId'
| eval roleArn = coalesce('userIdentity.sessionContext.sessionIssuer.arn','userIdentity.arn')
| rex field=roleArn "arn:aws:iam::\d+:role/(?<role_name>[^/]+)"
| stats count min(_time) as first_seen max(_time) as last_seen values(sourceIPAddress) as src_ips by eventName principalId_full role_name roleArn
| convert ctime(first_seen) ctime(last_seen)
| sort -count

